@inject IListingService ListingService
@inject IWorkerService WorkerService

@using System.Security.Claims
@model ListingDetailsServiceModel

@{
    ViewData["Title"] = "Listing Details";
}

<div class="container mt-4">
    <h2 class="mb-4 text-center">@Model.Title</h2>

    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title">@Model.Title</h5>
            <p class="card-text text-muted mb-2">
                <strong>Category:</strong> @Model.WorkerTypeCategory
            </p>
            <p class="card-text mb-2">
                <strong>Location:</strong> @Model.LocationAddress
            </p>
            <p class="card-text mb-2">
                <strong>Budget:</strong> @Model.Budget.ToString("F2") BGN
            </p>
            <p class="card-text mb-2">
                <strong>Status:</strong>
                <span class="badge bg-@(Model.ListingStatus == ListingStatus.Active ? "success" : "secondary")">
                    @Model.ListingStatus
                </span>
            </p>
            <p class="card-text mb-2">
                <strong>Uploader:</strong> @Model.Uploader
            </p>
            <p class="card-text mb-2">
                <strong>Worker:</strong> @(string.IsNullOrWhiteSpace(Model.Worker) ? "Not assigned" : Model.Worker)
            </p>
            <hr/>
            <p class="card-text">
                <strong>Description:</strong><br/>
                @Model.Description
            </p>
        </div>
    </div>

    <div class="mt-4 d-flex justify-content-between">
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Listings
        </a>

        <div class="d-flex gap-2">
            @if (await ListingService.IsOwnerAsync(Model.Id, User.Id()))
            {
                <a asp-action="Edit" asp-route-listingId="@Model.Id" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <form asp-action="Delete" asp-route-listingId="@Model.Id" method="post" class="d-inline">
                    <button type="submit" class="btn btn-danger"
                            onclick="return confirm('Are you sure you want to delete this listing?');">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            }
            else
            {
                var workerId = await WorkerService.GetWorkerIdByUserIdAsync(User.Id());

                @if (workerId != 0
                     && Model.ListingStatus == ListingStatus.Active
                     && Model.Worker == "No worker assigned")
                {
                    <a asp-action="Assign" asp-route-listingId="@Model.Id" class="btn btn-success">
                        Take this job
                    </a>
                }

                @if (workerId != 0
                     && Model.ListingStatus == ListingStatus.Assigned)
                {
                    <a asp-action="Complete" asp-route-listingId="@Model.Id" class="btn btn-warning">
                        Mark as completed
                    </a>
                }
            }
        </div>
    </div>
</div>